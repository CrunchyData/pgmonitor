
ccp_backrest_last_full_backup:
    query: "WITH all_backups AS 
            (SELECT data->>'name' AS stanza
                , jsonb_array_elements(data->'backup') AS backups  
                FROM jsonb_array_elements(monitor.pgbackrest_info()) as data)
            SELECT stanza
                , EXTRACT(epoch FROM (CURRENT_TIMESTAMP - (max(to_timestamp((backups->'timestamp'->>'stop')::bigint)))))  AS seconds_since_completed
            FROM all_backups where backups->>'type' = 'full' 
            GROUP BY stanza"
    metrics:
        - stanza: 
            usage: "LABEL"
            description: "PGBackrest Stanza Name"
        - seconds_since_completed:
            usage: "GAUGE"
            description: "Seconds since the last completed full backup"


ccp_backrest_last_incr_backup:
    query: "WITH all_backups AS 
            (SELECT data->>'name' AS stanza
                , jsonb_array_elements(data->'backup') AS backups  
                FROM jsonb_array_elements(monitor.pgbackrest_info()) as data)
            SELECT stanza
                , EXTRACT(epoch FROM (CURRENT_TIMESTAMP - (max(to_timestamp((backups->'timestamp'->>'stop')::bigint))))) AS seconds_since_completed
            FROM all_backups where backups->>'type' IN ('full', 'diff', 'incr')
            GROUP BY stanza"
    metrics:
        - stanza: 
            usage: "LABEL"
            description: "PGBackrest Stanza Name"
        - seconds_since_completed:
            usage: "GAUGE"
            description: "Seconds since the last completed full, differential or incremental backup. Incremental is always based off last full or differential."


ccp_backrest_last_diff_backup:
    query: "WITH all_backups AS 
            (SELECT data->>'name' AS stanza
                , jsonb_array_elements(data->'backup') AS backups  
                FROM jsonb_array_elements(monitor.pgbackrest_info()) as data)
            SELECT stanza
                , EXTRACT(epoch FROM (CURRENT_TIMESTAMP - (max(to_timestamp((backups->'timestamp'->>'stop')::bigint))))) AS seconds_since_completed
            FROM all_backups where backups->>'type' IN ('full', 'diff')
            GROUP BY stanza"
    metrics:
        - stanza: 
            usage: "LABEL"
            description: "PGBackrest Stanza Name"
        - seconds_since_completed:
            usage: "GAUGE"
            description: "Seconds since the last completed full or differential backup. Differential is always based off last full."

